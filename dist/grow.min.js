function GROWJS(e,t){var o=this;if(o.later=later,o.later.date.localTime(),!e)throw new Error("Grow.js requires an implementation.");if(!(o instanceof GROWJS))return new GROWJS(t);if(o.growFile=t?t:require("../../grow.json"),!o.growFile)throw new Error("Grow.js requires a grow.json file.");if(o.options=_.clone(o.growFile||{}),!(o.options.uuid&&o.options.token||!o.options.uuid&&!o.options.token))throw new Error("UUID and token are or both required or should be omitted and they will be generated.");Duplex.call(o,_.defaults(o.options,{objectMode:!0,readableObjectMode:!0,writableObjectMode:!0})),o.uuid=o.options.uuid||null,o.token=o.options.token||null,o.thing=o.options.thing||null,o._messageHandlerInstalled=!1,o.ddpclient=new DDPClient(_.defaults(o.options,{host:"localhost",port:3e3,ssl:!1,maintainCollections:!1})),o.connect(),o.registerActions(e),o.pipeInstance()}var _=require("underscore"),assert=require("assert"),DDPClient=require("ddp");EJSON=require("ddp-ejson");var util=require("util"),Duplex=require("stream").Duplex,Readable=require("stream").Readable,Writable=require("stream").Writable,fs=require("fs"),later=require("later");util.inherits(GROWJS,Duplex),GROWJS.prototype.connect=function(e){var t=this;t.ddpclient.connect(function(o,n){return o?e(o):(n?console.log("Reestablishment of a Grow server connection."):console.log("Grow server connection established."),t.uuid||t.token?t._afterConnect(e,{uuid:t.uuid,token:t.token}):(t.ddpclient.call("Device.register",[t.thing],function(o,n){return o?e(o):(assert(n.uuid,n),assert(n.token,n),t.uuid=n.uuid,t.token=n.token,t._afterConnect(e,n),void 0)}),void 0))})},GROWJS.prototype._afterConnect=function(e,t){var o=this;o.ddpclient.subscribe("Device.messages",[{uuid:o.uuid,token:o.token}],function(t){return t?e(t):(o._messageHandlerInstalled||(o._messageHandlerInstalled=!0,o.ddpclient.on("message",function(e){e=EJSON.parse(e),"added"===e.msg&&"Device.messages"===e.collection&&o.push(e.fields.body)})),void 0)}),(_.isUndefined(o.growFile.uuid)||_.isUndefined(o.growFile.token))&&(o.growFile.uuid=t.uuid,o.growFile.token=t.token,fs.writeFile("./grow.json",JSON.stringify(o.growFile,null,4),function(e){return e?console.log("Error",e):(console.log("New configration was saved with a uuid of: "+t.uuid),void 0)})),e(null,t)},GROWJS.prototype.readableStream=new Readable({objectMode:!0}),GROWJS.prototype.readableStream._read=function(){},GROWJS.prototype.readableStream.on("error",function(e){console.log("Error",e.message)}),GROWJS.prototype._read=function(){},GROWJS.prototype.writableStream=new Writable({objectMode:!0}),GROWJS.prototype._write=function(e,t,o){var n=this;n.sendData(e,o)},GROWJS.prototype.writableStream._write=function(e){var t=this,o=t.Actions.getActions();for(var n in o)e.type===n.call&&(e.options?t.Actions.call(n.call,e.options):t.Actions.call(n.call),t.updateProperty(n.actuator.name,"state",n.state),t.emitEvent({name:n.name,message:n.eventMessage}))},GROWJS.prototype.pipeInstance=function(){var e=this;this.pipe(e.writableStream),e.readableStream.pipe(this)},GROWJS.prototype.writeChangesToGrowFile=function(){var e=this;fs.writeFile("./grow.json",JSON.stringify(e.growFile,null,4),function(e){return e?console.log("Error",e):void 0})},GROWJS.prototype.getActions=function(){var e=[];for(var t in thing)if("actions"===t&&console.log(typeof thing[t]),"components"===t)for(var o in thing.components)for(t in o)"actions"===o[t]&&e.push(o[t]);return e},GROWJS.prototype.linkActions=function(e){{var t=this;t.Action.getActions()}for(var o in e)console.log(e[o]);t.pipeInstance()},GROWJS.prototype.writableStream._write=function(e){var t=this,o=t.getActions();for(var n in o)e.type===n.call&&(e.options?t.callFunction(n.call,e.options):t.callFunction(n.call),t.updateProperty(n.actuator.name,"state",n.state),t.emitEvent({name:n.name}))},GROWJS.prototype.registerEventListeners=function(){},GROWJS.prototype.writeChangesToGrowFile=function(){var e=this;fs.writeFile("./grow.json",JSON.stringify(e.growFile,null,4),function(e){return e?console.log("Error",e):void 0})},GROWJS.prototype.executeFunctionByName=function(e,t){for(var o=[].slice.call(arguments).splice(2),n=e.split("."),i=n.pop(),r=0;r<n.length;r++)t=t[n[r]];return t[i].apply(t,o)},GROWJS.prototype.callFunction=function(e){for(var t=e.split("."),o=this,n=0,i=t.length;i>n;n++)o=o[t[n]];if("function"!=typeof o)throw new Error("function not found");return o},GROWJS.prototype.registerActions=function(e){var t=this;t.actions=_.clone(e||{});for(var o=t.getActions(),n=[],i=o.length-1;i>=0;i--)if(n.push(o[i].call),o[i].every){var r=o[i].every,a=o[i].call;o[i].options?later.setInterval(t.callAction(a,options),r):later.setInterval(t.callAction(a),r)}return console.log(n),console.log(e),"function"==typeof t.acitons.start?t.actions.start():void 0},GROWJS.prototype.getActions=function(){var e=this,t=e.growFile.thing,o=[];for(var n in t){if("actions"===n)for(var i in t[n])o.push(i);if("components"===n)for(var r in t.components){r=t.components[r];for(var a in r)if("actions"===a){var s=r[a];for(var l in s)o.push(s[l])}}}return o},GROWJS.prototype.callAction=function(e,t){var o=this;return t?o.actions[e](t):o.actions[e]()},GROWJS.prototype.sendData=function(e,t){var o=this;return o.ddpclient&&o.uuid&&o.token?(o.ddpclient.call("Device.sendData",[{uuid:o.uuid,token:o.token},e],function(e,o){return e?t(e):(t(null,o),void 0)}),void 0):(t("Invalid connection state."),void 0)},GROWJS.prototype.emitEvent=function(e,t){var o=this;event={event:e,timestamp:new Date},o.ddpclient.call("Device.emitEvent",[{uuid:o.uuid,token:o.token},event],function(e,o){t(e,o)})},GROWJS.prototype.updateProperty=function(e,t,o,n){var i=this,r=i.growFile.thing;for(var a in r)if("components"===a)for(var s in r.components)r.components[s].name===e&&(r.components[s][t]=o);i.writeChangesToGrowFile(),i.ddpclient.call("Device.udpateProperties",[{uuid:i.uuid,token:i.token},r],function(e,t){n(e,t)})},module.exports=GROWJS;
//# sourceMappingURL=grow.min.js.map
